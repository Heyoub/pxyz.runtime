# TypeScript-Generated Golden Test Fixtures

This directory contains JSON fixtures generated by the TypeScript reference implementation.
These fixtures are used by `tests/runtime_golden.rs` to verify that the Rust runtime
produces identical results to TypeScript.

## Generating Fixtures

Run the TypeScript fixture generator:

```bash
cd adherify/server
npm run generate-fixtures
```

This will create/update:
- `ts_constraint_hashes.json` - Constraint hash corpus
- `ts_shape_snapshot.json` - Shape projection corpus

## Fixture Formats

### `ts_constraint_hashes.json`

```json
{
  "cases": [
    {
      "name": "simple_ltv_constraint",
      "yctx": {
        "name": "ltv_basic",
        "maxLtv": 0.97,
        "minCreditScore": 620
      },
      "expected_hash": "a1b2c3d4"
    },
    {
      "name": "order_invariant_same_keys_different_order",
      "yctx": {
        "c": 3,
        "a": 1,
        "b": 2
      },
      "expected_hash": "12345678"
    }
  ]
}
```

**Requirements**:
- Each case has a descriptive `name`
- `yctx` is the constraint context object to hash
- `expected_hash` is the 8-character lowercase hex hash produced by TS
- Include order-invariance test cases (same keys, different order)

### `ts_shape_snapshot.json`

```json
[
  {
    "shape_name": "LoanApplication",
    "projections": [
      {
        "name": "LoanApplicationAll",
        "query": "SELECT * FROM LoanApplication",
        "index_fields": ["id", "createdAt"]
      },
      {
        "name": "LoanApplicationActive",
        "query": "SELECT * FROM LoanApplication WHERE status != 'deleted'",
        "index_fields": ["status", "updatedAt"]
      },
      {
        "name": "LoanApplicationRecent",
        "query": "SELECT * FROM LoanApplication ORDER BY updatedAt DESC LIMIT 100",
        "index_fields": ["updatedAt"]
      }
    ]
  },
  {
    "shape_name": "Contact",
    "projections": [...]
  }
]
```

**Requirements**:
- Array of shape snapshots
- Each snapshot has `shape_name` and `projections` array
- Projections must match the default projection generation algorithm:
  - `{Name}All` - All records
  - `{Name}Active` - Records where status != 'deleted'
  - `{Name}Recent` - 100 most recent records by updatedAt

## Contract

If golden tests fail after regenerating fixtures, it means:

1. **TS changed**: The TypeScript implementation was modified
2. **Rust must update**: Rust must be updated to match TS exactly
3. **Breaking change**: This is a contract violation requiring investigation

**Never** modify these fixtures manually to make tests pass.
Always investigate and fix the implementation divergence.

## TypeScript Fixture Generator (Example)

Create `adherify/server/scripts/generate-fixtures.ts`:

```typescript
import { hashYCtx } from '../src/lib/ConstraintRegistry'
import { ShapeRegistry } from '../src/lib/ShapeRegistry'
import * as fs from 'fs'

// Generate constraint hash corpus
const constraintCases = [
  {
    name: 'simple_ltv_constraint',
    yctx: {
      name: 'ltv_basic',
      maxLtv: 0.97,
      minCreditScore: 620
    }
  },
  {
    name: 'order_invariant_same_keys_different_order',
    yctx: { c: 3, a: 1, b: 2 }
  },
  {
    name: 'order_invariant_reversed',
    yctx: { b: 2, a: 1, c: 3 }
  },
  // Add more cases...
]

const hashCorpus = {
  cases: constraintCases.map(c => ({
    name: c.name,
    yctx: c.yctx,
    expected_hash: hashYCtx(c.yctx)
  }))
}

fs.writeFileSync(
  '../pxyz/main/tests/fixtures/ts_constraint_hashes.json',
  JSON.stringify(hashCorpus, null, 2)
)

// Generate shape projection snapshots
const shapes = ['LoanApplication', 'Contact', 'Property', 'Task']
const registry = new ShapeRegistry()

const shapeSnapshots = shapes.map(name => {
  registry.register({ name, options: {}, status: 'active' })
  const shape = registry.get(name)
  return {
    shape_name: name,
    projections: shape.projections.map(p => ({
      name: p.name,
      query: p.query,
      index_fields: p.indexFields
    }))
  }
})

fs.writeFileSync(
  '../pxyz/main/tests/fixtures/ts_shape_snapshot.json',
  JSON.stringify(shapeSnapshots, null, 2)
)

console.log('âœ… Fixtures generated successfully')
```

Add to `package.json`:

```json
{
  "scripts": {
    "generate-fixtures": "ts-node scripts/generate-fixtures.ts"
  }
}
```
